name: 'General - Link Check for Documentation Sites'

on:
  # Runs every weekday at 12:00 UTC.
  schedule:
    - cron: '0 12 * * 1-5'
  # Allows you to run this workflow manually from the Actions tab.
  workflow_dispatch:
    inputs:
      selected_project:
        description: 'Select a specific project (optional)'
        required: false
        type: choice
        options:
          - All
          - Tanssi
          - Moonbeam
          - Wormhole
          - kluster.ai
          - Polkadot
      create_issue:
        description: 'Create GitHub Issue if broken links are found?'
        required: false
        type: boolean
        default: true
      mkdocs_branch:
        description: 'MkDocs repo branch to use (only when running a specific project)'
        required: false
        type: string
        default: ''
      docs_branch:
        description: 'Docs content repo branch to use (only when running a specific project)'
        required: false
        type: string
        default: ''

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set filtered matrix
        id: set-matrix
        shell: bash
        run: |
          selected="${{ github.event.inputs.selected_project || 'All' }}"

          all_projects=$(jq -n '
            [
              { "mkdocs_repo": "papermoonio/kluster-mkdocs", "docs_repo": "kluster-ai/docs", "mkdocs_repo_name": "kluster-mkdocs", "docs_repo_name": "kluster-docs", "root_dir": "", "label": "kluster.ai" },
              { "mkdocs_repo": "papermoonio/polkadot-mkdocs", "docs_repo": "polkadot-developers/polkadot-docs", "mkdocs_repo_name": "polkadot-mkdocs", "docs_repo_name": "polkadot-docs", "root_dir": "", "label": "Polkadot" },
              { "mkdocs_repo": "papermoonio/moonbeam-mkdocs", "docs_repo": "moonbeam-foundation/moonbeam-docs", "mkdocs_repo_name": "moonbeam-mkdocs", "docs_repo_name": "moonbeam-docs", "root_dir": "", "label": "Moonbeam" },
              { "mkdocs_repo": "papermoonio/tanssi-mkdocs", "docs_repo": "moondance-labs/tanssi-docs", "mkdocs_repo_name": "tanssi-mkdocs", "docs_repo_name": "tanssi-docs", "root_dir": "", "label": "Tanssi" },
              { "mkdocs_repo": "papermoonio/wormhole-mkdocs", "docs_repo": "wormhole-foundation/wormhole-docs", "mkdocs_repo_name": "wormhole-mkdocs", "docs_repo_name": "wormhole-docs", "root_dir": "/docs", "label": "Wormhole" }
            ]
          ')

          if [ "$selected" == "All" ]; then
            filtered="$all_projects"
          else
            filtered=$(echo "$all_projects" | jq -c --arg sel "$selected" '[.[] | select(.label == $sel)]')
          fi

          if [ -z "$filtered" ] || [ "$filtered" = "[]" ]; then
            echo "âŒ Error: No projects matched filter '$selected'."
            exit 1
          fi

          echo "matrix=$(echo "$filtered" | jq -c '.')" >> "$GITHUB_OUTPUT"

  check-links:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}

    steps:
      - name: Select Token
        id: select_token
        run: |
          if [ "${{ matrix.label }}" == "Tanssi" ]; then
            echo "token=${{ secrets.GH_404_CHECKER_TANSSI }}" >> $GITHUB_OUTPUT
          else
            echo "token=${{ secrets.GH_404_CHECKER }}" >> $GITHUB_OUTPUT
          fi

      - name: Resolve branches/refs
        id: refs
        shell: bash
        run: |
          selected="${{ github.event.inputs.selected_project || 'All' }}"
          mkdocs_ref="${{ github.event.inputs.mkdocs_branch || '' }}"
          docs_ref="${{ github.event.inputs.docs_branch || '' }}"

          if [[ "${{ github.event_name }}" != "workflow_dispatch" || "$selected" == "All" ]]; then
            mkdocs_ref=""
            docs_ref=""
          fi

          echo "mkdocs_ref=$mkdocs_ref" >> "$GITHUB_OUTPUT"
          echo "docs_ref=$docs_ref" >> "$GITHUB_OUTPUT"

      - name: 'Checkout MkDocs Repo'
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.mkdocs_repo }}
          ref: ${{ steps.refs.outputs.mkdocs_ref }}
          path: ${{ matrix.mkdocs_repo_name }}

      - name: 'Checkout Docs Content Repo'
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.docs_repo }}
          ref: ${{ steps.refs.outputs.docs_ref }}
          fetch-depth: 0
          path: '${{ matrix.mkdocs_repo_name}}/${{ matrix.docs_repo_name}}'

      - name: 'Set up Python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: 'Install dependencies'
        working-directory: ${{ matrix.mkdocs_repo_name }}
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: 'Build MkDocs site'
        working-directory: ${{ matrix.mkdocs_repo_name }}
        run: mkdocs build -d site${{ matrix.root_dir }}

      - name: Read MkDocs config (site_url)
        id: mkdocs_cfg
        working-directory: ${{ matrix.mkdocs_repo_name }}
        shell: bash
        run: |
          python - <<'PY' >> "$GITHUB_OUTPUT"
          from mkdocs import config as mkdocs_config
          try:
              cfg = mkdocs_config.load_config("mkdocs.yml")
              site_url = (cfg.get("site_url") or "").rstrip("/")
              print(f"site_url={site_url}")
          except Exception:
              print(f"site_url=")
          PY

      - name: Prepare Lychee Arguments
        id: lychee_args
        shell: bash
        run: |
          # The --remap flag solves the "new page" problem by mapping the site_url to the local folder
          ARGS="--root-dir $(pwd)/${{ matrix.mkdocs_repo_name }}/site --verbose --no-progress --accept 429,403"
          
          if [[ -n "${{ steps.mkdocs_cfg.outputs.site_url }}" ]]; then
            ARGS="$ARGS --remap '${{ steps.mkdocs_cfg.outputs.site_url }} $(pwd)/${{ matrix.mkdocs_repo_name }}/site'"
          fi

          if [[ -f "$(pwd)/${{ matrix.mkdocs_repo_name }}/.urlignore" ]]; then
            ARGS="$ARGS --exclude-file $(pwd)/${{ matrix.mkdocs_repo_name }}/.urlignore"
          fi

          echo "args=$ARGS" >> $GITHUB_OUTPUT

      - name: Run Link Checker (Attempt 1)
        id: lychee1
        uses: lycheeverse/lychee-action@v2.4.1
        with:
          args: >
            ${{ steps.lychee_args.outputs.args }}
            './${{ matrix.mkdocs_repo_name }}/site/**/*.html'
          output: ./${{ matrix.mkdocs_repo_name }}/lychee-report.md
          fail: true
        continue-on-error: true

      - name: Backoff 1
        if: steps.lychee1.outcome == 'failure'
        run: sleep 60

      - name: Run Link Checker (Attempt 2)
        if: steps.lychee1.outcome == 'failure'
        id: lychee2
        uses: lycheeverse/lychee-action@v2.4.1
        with:
          args: >
            ${{ steps.lychee_args.outputs.args }}
            './${{ matrix.mkdocs_repo_name }}/site/**/*.html'
          output: ./${{ matrix.mkdocs_repo_name }}/lychee-report.md
          fail: true
        continue-on-error: true

      - name: Backoff 2
        if: steps.lychee1.outcome == 'failure' && steps.lychee2.outcome == 'failure'
        run: sleep 120

      - name: Run Link Checker (Attempt 3)
        if: steps.lychee1.outcome == 'failure' && steps.lychee2.outcome == 'failure'
        id: lychee3
        uses: lycheeverse/lychee-action@v2.4.1
        with:
          args: >
            ${{ steps.lychee_args.outputs.args }}
            './${{ matrix.mkdocs_repo_name }}/site/**/*.html'
          output: ./${{ matrix.mkdocs_repo_name }}/lychee-report.md
          fail: true
        continue-on-error: true

      - name: Set Final Outcome
        id: lychee_status
        shell: bash
        run: |
          if [[ "${{ steps.lychee1.outcome }}" == "success" || "${{ steps.lychee2.outcome }}" == "success" || "${{ steps.lychee3.outcome }}" == "success" ]]; then
            echo "final_outcome=success" >> $GITHUB_OUTPUT
          else
            echo "final_outcome=failure" >> $GITHUB_OUTPUT
          fi

      - name: 'Read Link Checker Report'
        if: steps.lychee_status.outputs.final_outcome == 'failure'
        id: report
        shell: bash
        run: |
          report_body=$(cat ./${{ matrix.mkdocs_repo_name }}/lychee-report.md)
          {
            echo "body<<EOF"
            echo "### ðŸš¨ Broken Links Detected in ${{ matrix.label }} Docs"
            echo "This was found after 3 attempts. [Link to Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            echo ""
            echo "$report_body"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create Issue on Failure
        if: steps.lychee_status.outputs.final_outcome == 'failure' && ((github.event_name == 'workflow_dispatch' && github.event.inputs.create_issue == 'true') || github.event_name == 'schedule')
        env:
          GH_TOKEN: ${{ steps.select_token.outputs.token }}
        run: |
          gh issue create \
            --repo "${{ matrix.docs_repo }}" \
            --title "Broken Links Detected on $(date +'%Y-%m-%d')" \
            --body "${{ steps.report.outputs.body }}"

      - name: Final Job Failure
        if: steps.lychee_status.outputs.final_outcome == 'failure'
        run: |
          echo "Link checker failed after 3 attempts."
          exit 1
