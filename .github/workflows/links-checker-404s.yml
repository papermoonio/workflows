name: 'General - Link Check for Documentation Sites'

on:
  schedule:
    - cron: '0 12 * * 1-5'
  workflow_dispatch:
    inputs:
      selected_project:
        description: 'Select a specific project (optional)'
        required: false
        type: choice
        options:
          - All
          - Tanssi
          - Moonbeam
          - DataHaven
          - Wormhole
          - kluster.ai
          - Polkadot
      create_issue:
        description: 'Create GitHub Issue if broken links are found?'
        required: false
        type: boolean
        default: true
      mkdocs_branch:
        description: 'MkDocs repo branch to use (only for specific project runs)'
        required: false
        type: string
        default: ''
      docs_branch:
        description: 'Docs content repo branch to use (only for specific project runs)'
        required: false
        type: string
        default: ''

jobs:
  generate-matrix:
    name: Initialization
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Define Project Matrix
        id: set-matrix
        shell: bash
        run: |
          selected="${{ github.event.inputs.selected_project || 'All' }}"
          # NOTE: "exclude_paths" is passed as a JSON array.
          # The Python script in the next job will convert "pt" into regex "(?:^|/)pt/".
          all_projects=$(jq -n '
            [
              { "mkdocs_repo": "papermoonio/kluster-mkdocs", "docs_repo": "kluster-ai/docs", "mkdocs_repo_name": "kluster-mkdocs", "docs_repo_name": "kluster-docs", "root_dir": "", "label": "kluster.ai", "exclude_paths": [] },
              { "mkdocs_repo": "papermoonio/polkadot-mkdocs", "docs_repo": "polkadot-developers/polkadot-docs", "mkdocs_repo_name": "polkadot-mkdocs", "docs_repo_name": "polkadot-docs", "root_dir": "", "label": "Polkadot", "exclude_paths": [] },
              { "mkdocs_repo": "papermoonio/moonbeam-mkdocs", "docs_repo": "moonbeam-foundation/moonbeam-docs", "mkdocs_repo_name": "moonbeam-mkdocs", "docs_repo_name": "moonbeam-docs", "root_dir": "", "label": "Moonbeam", "exclude_paths": [] },
              { "mkdocs_repo": "papermoonio/datahaven-mkdocs", "docs_repo": "datahaven-xyz/datahaven-docs", "mkdocs_repo_name": "datahaven-mkdocs", "docs_repo_name": "datahaven-docs", "root_dir": "", "label": "DataHaven", "exclude_paths": [] },
              { "mkdocs_repo": "papermoonio/tanssi-mkdocs", "docs_repo": "moondance-labs/tanssi-docs", "mkdocs_repo_name": "tanssi-mkdocs", "docs_repo_name": "tanssi-docs", "root_dir": "", "label": "Tanssi", "exclude_paths": ["pt"] },
              { "mkdocs_repo": "papermoonio/wormhole-mkdocs", "docs_repo": "wormhole-foundation/wormhole-docs", "mkdocs_repo_name": "wormhole-mkdocs", "docs_repo_name": "wormhole-docs", "root_dir": "/docs", "label": "Wormhole", "exclude_paths": [] }
            ]
          ')
          if [ "$selected" == "All" ]; then
            filtered="$all_projects"
          else
            filtered=$(echo "$all_projects" | jq -c --arg sel "$selected" '[.[] | select(.label == $sel)]')
          fi
          echo "matrix=$(echo "$filtered" | jq -c '.')" >> "$GITHUB_OUTPUT"

  check-links:
    name: Check Links (${{ matrix.label }})
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}

    steps:
      - name: Authenticate GitHub Token
        id: select_token
        run: |
          if [ "${{ matrix.label }}" == "Tanssi" ]; then
            echo "token=${{ secrets.GH_404_CHECKER_TANSSI }}" >> $GITHUB_OUTPUT
          else
            echo "token=${{ secrets.GH_404_CHECKER }}" >> $GITHUB_OUTPUT
          fi

      - name: Resolve Environment Refs
        id: refs
        shell: bash
        run: |
          selected="${{ github.event.inputs.selected_project || 'All' }}"
          mkdocs_ref="${{ github.event.inputs.mkdocs_branch || '' }}"
          docs_ref="${{ github.event.inputs.docs_branch || '' }}"
          if [[ "${{ github.event_name }}" != "workflow_dispatch" || "$selected" == "All" ]]; then
            mkdocs_ref=""; docs_ref=""
          fi
          echo "mkdocs_ref=$mkdocs_ref" >> "$GITHUB_OUTPUT"
          echo "docs_ref=$docs_ref" >> "$GITHUB_OUTPUT"

      - name: Checkout Repositories
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.mkdocs_repo }}
          ref: ${{ steps.refs.outputs.mkdocs_ref }}
          path: ${{ matrix.mkdocs_repo_name }}

      - name: Checkout Documentation Content
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.docs_repo }}
          ref: ${{ steps.refs.outputs.docs_ref }}
          fetch-depth: 0
          path: '${{ matrix.mkdocs_repo_name}}/${{ matrix.docs_repo_name}}'

      - name: Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Site Dependencies
        working-directory: ${{ matrix.mkdocs_repo_name }}
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install mkdocs-material mkdocs

      - name: Build Static Site
        working-directory: ${{ matrix.mkdocs_repo_name }}
        run: mkdocs build -d site${{ matrix.root_dir }}

      - name: Initialize Local Web Server
        id: serve
        shell: bash
        run: |
          set -euo pipefail
          ABS_SITE_ROOT="$(pwd)/${{ matrix.mkdocs_repo_name }}/site${{ matrix.root_dir }}"
          python3 -m http.server 8000 --directory "$ABS_SITE_ROOT" > /tmp/mkdocs_http.log 2>&1 &
          echo "pid=$!" >> "$GITHUB_OUTPUT"

          for i in {1..15}; do
            if curl -s http://localhost:8000 > /dev/null; then
              echo "‚úÖ Server ready on port 8000"
              exit 0
            fi
            sleep 2
          done
          echo "‚ùå Server failed to start." && exit 1

      - name: Extract MkDocs Configuration
        id: mkdocs_cfg
        working-directory: ${{ matrix.mkdocs_repo_name }}
        shell: bash
        run: |
          python - <<'PY' >> "$GITHUB_OUTPUT"
          from mkdocs import config as mkdocs_config
          try:
              cfg = mkdocs_config.load_config("mkdocs.yml")
              site_url = (cfg.get("site_url") or "").rstrip("/")
              print(f"site_url={site_url}")
          except Exception:
              print(f"site_url=")
          PY

      - name: Configure Lychee Engine
        id: lychee_cfg
        shell: bash
        run: |
          # Use Python to generate TOML to avoid Bash escaping/quoting issues
          python3 - <<'EOF'
          import json
          import os
          import re

          # Input Data
          base_url = "${{ steps.mkdocs_cfg.outputs.site_url }}".rstrip('/')
          local_server = "http://localhost:8000"
          
          # Safely parse JSON array from Matrix
          try:
              exclude_paths_raw = json.loads('${{ toJson(matrix.exclude_paths) }}')
          except Exception as e:
              print(f"Error parsing exclude_paths: {e}")
              exclude_paths_raw = []

          # Construct Regex List
          exclude_regex = []
          for path in exclude_paths_raw:
              if not path: continue
              # If it looks like a regex (has special chars), keep it as is
              # Otherwise, wrap it to match a folder segment
              if any(char in path for char in r"\.^$*+?()[]{}|"):
                  exclude_regex.append(path)
              else:
                  # Matches "start of line OR /" + path + "/"
                  # This ensures we match "/pt/" or "pt/" but not "opt/"
                  clean_path = path.strip('/')
                  exclude_regex.append(f"(?:^|/){clean_path}/")

          # Build TOML Content
          toml_lines = [
              "exclude_all_private = false",
              "exclude_loopback = false",
              "exclude_private = false",
              "exclude_link_local = false",
              "extensions = ['html']",
              "include = [",
              "  '^http://localhost:8000',",
              "  '^http://127\\.0\\.0\\.1:8000'",
              "]",
              "accept = [403, 429]",
              "max_retries = 3",
              "retry_wait_time = 10"
          ]

          # Add Remap
          if base_url:
              toml_lines.append("remap = [")
              toml_lines.append(f"  '{base_url}/ {local_server}/',")
              toml_lines.append(f"  '{base_url} {local_server}'")
              toml_lines.append("]")

          # Add Excludes
          if exclude_regex:
              toml_lines.append("exclude_path = [")
              for pattern in exclude_regex:
                  # Python's repr() ensures safe string escaping for TOML
                  toml_lines.append(f"  {repr(pattern)},")
              toml_lines.append("]")

          # Write to file
          with open("/tmp/lychee.ci.toml", "w") as f:
              f.write("\n".join(toml_lines))
          
          EOF
          
          echo "cfg=/tmp/lychee.ci.toml" >> "$GITHUB_OUTPUT"
          
          echo "::group::Generated Lychee Configuration"
          cat /tmp/lychee.ci.toml
          echo "::endgroup::"

      - name: Generate Link Checker Arguments
        id: lychee_args
        shell: bash
        run: |
          set -euo pipefail
          
          ABS_SITE_PATH="$(pwd)/${{ matrix.mkdocs_repo_name }}/site"
          
          # We pass verbose/progress as CLI flags, avoiding the boolean/string TOML error
          ARGS="--config ${{ steps.lychee_cfg.outputs.cfg }} --root-dir $ABS_SITE_PATH --verbose --no-progress"

          # Check for .urlignore file
          URLIGNORE_PATH="$(pwd)/${{ matrix.mkdocs_repo_name }}/.urlignore"
          if [[ -f "$URLIGNORE_PATH" ]]; then
            ARGS="$ARGS --exclude-file $URLIGNORE_PATH"
          fi

          echo "args=$ARGS" >> $GITHUB_OUTPUT

      - name: Link Check
        id: lychee
        uses: lycheeverse/lychee-action@v2.4.1
        with:
          # Note: We pass the directory path. The TOML 'extensions' handles filtering.
          args: ${{ steps.lychee_args.outputs.args }} './${{ matrix.mkdocs_repo_name }}/site/**/*.html'
          output: ./${{ matrix.mkdocs_repo_name }}/lychee-report.md
        continue-on-error: true

      - name: Consolidate Results
        id: lychee_status
        shell: bash
        run: |
          if [[ "${{ steps.lychee.outcome }}" == "success" ]]; then
            echo "has_broken_links=false" >> $GITHUB_OUTPUT
          else
            echo "has_broken_links=true" >> $GITHUB_OUTPUT
          fi
          
          CREATE_ISSUE="false"
          if [[ "${{ github.event_name }}" == "schedule" ]] || [[ "${{ github.event.inputs.create_issue }}" == "true" ]]; then
            CREATE_ISSUE="true"
          fi
          echo "should_open_issue=$CREATE_ISSUE" >> $GITHUB_OUTPUT

      - name: Cleanup Local Server
        if: always()
        run: kill ${{ steps.serve.outputs.pid }} || true

      - name: Create Failure Issue
        if: steps.lychee_status.outputs.has_broken_links == 'true' && steps.lychee_status.outputs.should_open_issue == 'true'
        env:
          GH_TOKEN: ${{ steps.select_token.outputs.token }}
        run: |
          REPORT=$(cat ./${{ matrix.mkdocs_repo_name }}/lychee-report.md)
          gh issue create \
            --repo "${{ matrix.docs_repo }}" \
            --title "Broken Links Found: ${{ matrix.label }}" \
            --body "### üö® Link Checker Report
            **Project:** ${{ matrix.label }}
            **Date:** $(date +'%Y-%m-%d')
            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ---
            $REPORT"
