name: 'General - PR Core Link Checker'

on:
  workflow_call:
    inputs:
      mkdocs_repo:
        required: true
        type: string
      docs_repo:
        required: true
        type: string
      docs_checkout:
        required: true
        type: string
      url:
        required: true
        type: string
        description: 'The base URL of the deployed docs site (e.g., https://docs.project.com)'
      root_dir:
        required: false
        type: string
        default: ''
    secrets:
      GH_TOKEN:
        required: true

jobs:
  check-links:
    runs-on: ubuntu-latest
    steps:
      - name: 'Set up workflow variables'
        id: vars
        run: |
          echo "mkdocs_repo_name=$(basename ${{ inputs.mkdocs_repo }})" >> $GITHUB_OUTPUT
          echo "docs_repo_name=$(basename ${{ inputs.docs_repo }})" >> $GITHUB_OUTPUT
          echo "docs_checkout_path=$(basename ${{ inputs.docs_checkout }})" >> $GITHUB_OUTPUT

      - name: 'Checkout MkDocs Repo'
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.mkdocs_repo }}
          path: ${{ steps.vars.outputs.mkdocs_repo_name }}

      - name: 'Checkout Docs Repo into MkDocs'
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.docs_repo }}
          path: ${{ steps.vars.outputs.mkdocs_repo_name }}/${{ steps.vars.outputs.docs_checkout_path }}
          ref: ${{ github.event.pull_request.head.ref }}

      - name: 'Set up Python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: '${{ steps.vars.outputs.mkdocs_repo_name }}/requirements.txt'

      - name: 'Install dependencies'
        working-directory: ${{ steps.vars.outputs.mkdocs_repo_name }}
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install mkdocs-material mkdocs

      - name: 'Build MkDocs site'
        working-directory: ${{ steps.vars.outputs.mkdocs_repo_name }}
        run: mkdocs build -d site${{ inputs.root_dir }}

      - name: 'Prepare lychee arguments'
        id: lychee_args
        shell: bash
        run: |
          # 1. Define the absolute path to the local site
          MKDOCS_REPO="${{ steps.vars.outputs.mkdocs_repo_name }}"
          ABS_SITE_PATH="${{ github.workspace }}/${MKDOCS_REPO}/site${{ inputs.root_dir }}"
          
          # 2. Base arguments
          # --include-index: handles the /quickstart -> /quickstart/index.html mapping
          # --exclude '.*#.*': Regex to ignore any URL with a fragment before Lychee tries to find the file
          ARGS="--root-dir $ABS_SITE_PATH --verbose --no-progress --accept 429,403 --include-index --exclude '.*#.*'"
          
          # 3. Add Remap Logic (Production URL -> Local file:// URI)
          if [[ -n "${{ inputs.url }}" ]]; then
            # Strip trailing slash from URL to ensure clean mapping
            BASE_URL=$(echo "${{ inputs.url }}" | sed 's/\/$//')
            
            # Map production URL to the local filesystem
            FILE_URI="file://$ABS_SITE_PATH"
            
            # Remap both the version with and without the slash
            ARGS="$ARGS --remap '$BASE_URL/ $FILE_URI/' --remap '$BASE_URL $FILE_URI'"
          fi

          # 4. Handle ignores from .urlignore
          URLIGNORE_PATH="${{ github.workspace }}/${MKDOCS_REPO}/.urlignore"
          if [[ -f "$URLIGNORE_PATH" ]]; then
            ARGS="$ARGS --exclude-file '$URLIGNORE_PATH'"
          fi

          # 5. Define scan targets
          SCAN_TARGETS="$ABS_SITE_PATH/**/*.html"
          
          echo "args=$ARGS $SCAN_TARGETS" >> $GITHUB_OUTPUT

      - name: 'Run Link Checker (Attempt 1)'
        id: lychee1
        uses: lycheeverse/lychee-action@v2.4.1
        with:
          args: ${{ steps.lychee_args.outputs.args }}
          fail: true
        continue-on-error: true

      - name: 'Backoff 1'
        if: steps.lychee1.outcome == 'failure'
        run: sleep 60

      - name: 'Run Link Checker (Attempt 2)'
        if: steps.lychee1.outcome == 'failure'
        id: lychee2
        uses: lycheeverse/lychee-action@v2.4.1
        with:
          args: ${{ steps.lychee_args.outputs.args }}
          fail: true
        continue-on-error: true

      - name: 'Backoff 2'
        if: steps.lychee1.outcome == 'failure' && steps.lychee2.outcome == 'failure'
        run: sleep 120

      - name: 'Run Link Checker (Attempt 3)'
        if: steps.lychee1.outcome == 'failure' && steps.lychee2.outcome == 'failure'
        id: lychee3
        uses: lycheeverse/lychee-action@v2.4.1
        with:
          args: ${{ steps.lychee_args.outputs.args }}
          fail: true
        continue-on-error: true

      - name: 'Determine Final Status'
        if: always()
        shell: bash
        run: |
          if [[ "${{ steps.lychee1.outcome }}" == "success" || "${{ steps.lychee2.outcome }}" == "success" || "${{ steps.lychee3.outcome }}" == "success" ]]; then
            echo "✅ Link check passed."
            exit 0
          else
            echo "❌ Link check failed after 3 attempts."
            exit 1
          fi
