name: 'General - PR Core Link Checker'

on:
  workflow_call:
    inputs:
      mkdocs_repo:
        required: true
        type: string
      docs_repo:
        required: true
        type: string
      docs_checkout:
        required: true
        type: string
      url:
        required: true
        type: string
        description: 'The base URL of the deployed docs site (e.g., https://docs.project.com)'
      root_dir:
        required: false
        type: string
        default: ''
      exclude_paths:
        required: false
        type: string
        default: '[]'
        description: 'JSON array of folder segments to ignore (e.g. ["pt","es"]). Core expands these to regex.'
    secrets:
      GH_TOKEN:
        required: true

jobs:
  check-links:
    name: PR Link Validation
    runs-on: ubuntu-latest
    steps:
      - name: Set Workflow Variables
        id: vars
        run: |
          echo "mkdocs_repo_name=$(basename ${{ inputs.mkdocs_repo }})" >> $GITHUB_OUTPUT
          echo "docs_repo_name=$(basename ${{ inputs.docs_repo }})" >> $GITHUB_OUTPUT
          echo "docs_checkout_path=$(basename ${{ inputs.docs_checkout }})" >> $GITHUB_OUTPUT

      - name: Checkout MkDocs Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.mkdocs_repo }}
          path: ${{ steps.vars.outputs.mkdocs_repo_name }}

      - name: Checkout PR Documentation Content
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.docs_repo }}
          path: ${{ steps.vars.outputs.mkdocs_repo_name }}/${{ steps.vars.outputs.docs_checkout_path }}
          # We check out the simulated merge commit (refs/pull/ID/merge)
          # instead of the raw branch head.
          ref: refs/pull/${{ github.event.pull_request.number }}/merge

      - name: Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: '${{ steps.vars.outputs.mkdocs_repo_name }}/requirements.txt'

      - name: Install Dependencies
        working-directory: ${{ steps.vars.outputs.mkdocs_repo_name }}
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install mkdocs-material mkdocs

      - name: Build Static Site
        working-directory: ${{ steps.vars.outputs.mkdocs_repo_name }}
        run: mkdocs build -d site${{ inputs.root_dir }}

      - name: Initialize Local Web Server
        id: serve
        shell: bash
        run: |
          set -euo pipefail
          ABS_SITE_ROOT="$(pwd)/${{ steps.vars.outputs.mkdocs_repo_name }}/site${{ inputs.root_dir }}"
          python3 -m http.server 8000 --directory "$ABS_SITE_ROOT" > /tmp/mkdocs_http.log 2>&1 &
          echo "pid=$!" >> "$GITHUB_OUTPUT"
          
          echo "Waiting for local server..."
          for i in {1..15}; do
            if curl -s http://localhost:8000 > /dev/null; then
              echo "✅ Server ready."
              exit 0
            fi
            sleep 2
          done
          echo "❌ Server failed to start." && exit 1

      - name: Configure Lychee Engine
        id: lychee_cfg
        shell: bash
        run: |
          set -euo pipefail

          BASE_URL="$(echo "${{ inputs.url }}" | sed 's/\/$//')"
          LOCAL_SERVER="http://localhost:8000"

          # 1. Generate Base TOML Configuration
          cat > /tmp/lychee.ci.toml <<'TOML'
          verbose = true
          no_progress = true
          exclude_all_private = false
          exclude_loopback = false
          exclude_private = false
          exclude_link_local = false
          
          # Only parse HTML files (replaces the need for globbing in the command line)
          extensions = ["html"]

          include = [
            '^http://localhost:8000',
            '^http://127\.0\.0\.1:8000'
          ]
          
          # Treat these codes as valid to prevent flakes on external rate limits
          accept = [403, 429]
          max_retries = 3
          retry_wait_time = 10
          TOML

          # 2. Append Remap Logic (Deployed URL -> Localhost)
          if [[ -n "$BASE_URL" ]]; then
            {
              echo ""
              echo "remap = ["
              echo "  \"${BASE_URL}/ ${LOCAL_SERVER}/\","
              echo "  \"${BASE_URL} ${LOCAL_SERVER}\""
              echo "]"
            } >> /tmp/lychee.ci.toml
          fi

          # 3. Append Exclude Paths (Dynamic Regex Generation)
          # We use jq to parse the JSON array input safely
          jq -r '.[]' <<< '${{ inputs.exclude_paths }}' > /tmp/exclusions_raw.txt || true

          if [[ -s /tmp/exclusions_raw.txt ]]; then
            echo "" >> /tmp/lychee.ci.toml
            echo "exclude_path = [" >> /tmp/lychee.ci.toml

            while IFS= read -r token; do
              [[ -z "$token" ]] && continue

              # If the token contains special regex characters, assume the user provided a raw regex
              if [[ "$token" =~ [/\.\^\$\*\+\?\(\)\[\]\{\}\|] ]]; then
                pattern="$token"
              else
                # Otherwise, assume it's a simple folder name and wrap it in regex
                pattern="(^|/)${token}/"
              fi

              echo "  \"${pattern}\"," >> /tmp/lychee.ci.toml
            done < /tmp/exclusions_raw.txt

            echo "]" >> /tmp/lychee.ci.toml
          fi

          echo "cfg=/tmp/lychee.ci.toml" >> "$GITHUB_OUTPUT"

      - name: Generate Link Checker Arguments
        id: lychee_args
        shell: bash
        run: |
          set -euo pipefail
          
          ABS_SITE_PATH="$(pwd)/${{ steps.vars.outputs.mkdocs_repo_name }}/site${{ inputs.root_dir }}"
          
          # Base arguments using the generated config file
          ARGS="--config ${{ steps.lychee_cfg.outputs.cfg }} --root-dir $ABS_SITE_PATH"
          
          # Check for .urlignore file
          URLIGNORE_PATH="$(pwd)/${{ steps.vars.outputs.mkdocs_repo_name }}/.urlignore"
          if [[ -f "$URLIGNORE_PATH" ]]; then
            ARGS="$ARGS --exclude-file $URLIGNORE_PATH"
          fi

          echo "args=$ARGS" >> $GITHUB_OUTPUT

      - name: Link Check
        id: lychee
        uses: lycheeverse/lychee-action@v2.4.1
        with:
          # Note: We pass the directory path, not a glob. 
          # The TOML 'extensions = ["html"]' handles the filtering.
          args: ${{ steps.lychee_args.outputs.args }} './${{ steps.vars.outputs.mkdocs_repo_name }}/site${{ inputs.root_dir }}'

      - name: Cleanup Local Server
        if: always()
        run: kill ${{ steps.serve.outputs.pid }} || true
