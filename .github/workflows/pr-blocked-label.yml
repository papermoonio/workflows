name: General - Prevent Merge on Non-Whitelisted PRs

on:
  workflow_call:
    inputs:
      whitelist_labels:
        description: 'Comma-separated list of labels that are required for PR merging'
        required: true
        type: string
  pull_request:
    types: [labeled, unlabeled, opened, edited, synchronize, reopened]

jobs:
  authorize-caller:
    uses: ./.github/workflows/core-authorize-caller.yml

  check-label:
    needs: authorize-caller
    runs-on: ubuntu-latest
    steps:
      - name: Check for whitelist labels
        uses: actions/github-script@v7
        with:
          script: |
            const whitelistLabels = "${{ inputs.whitelist_labels }}".split(',').map(label => label.trim());
            const prNumber = context.payload.pull_request.number;
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const foundWhitelistLabels = labels.filter(label => 
              whitelistLabels.includes(label.name)
            );
            
            if (foundWhitelistLabels.length === 0) {
              const requiredLabelNames = whitelistLabels.join(', ');
              core.setFailed(`PR cannot be merged because it must have at least one of the following labels: "${requiredLabelNames}"`);
            }
